AWSTemplateFormatVersion: '2010-09-09'
Description: Amazon EKS - Cluster
Parameters:
  NodeEnv:
    Type: String
  Region:
    Type: String
  ProjectName:
    Type: String
  NodeInstanceRoleArn:
    Type: String
  eksClusterRoleArn:
    Type: String
  ControlPlaneSecurityGroupId:
    Type: String
  PublicSubnet01Id:
    Type: String
  PublicSubnet02Id:
    Type: String
Resources:
  ClusterEks:
    Type: AWS::EKS::Cluster
    Properties:
      Name:
        Fn::Sub: ${NodeEnv}-k8s-kluster
      ResourcesVpcConfig:
        SecurityGroupIds:
        - Ref: ControlPlaneSecurityGroupId
        SubnetIds:
        - Ref: PublicSubnet01Id
        - Ref: PublicSubnet02Id
      RoleArn:
        Ref: eksClusterRoleArn
  WebServerNodeGroup:
    DependsOn:
    - ClusterEks
    Type: AWS::EKS::Nodegroup
    Properties:
      ClusterName:
        Ref: ClusterEks
      InstanceTypes:
      - t2.micro
      NodegroupName:
        Fn::Sub: ${NodeEnv}-webserver-nodegroup
      NodeRole:
        Ref: NodeInstanceRoleArn
      ScalingConfig:
        DesiredSize: 0
        MaxSize: 1
        MinSize: 0
      Subnets:
      - Ref: PublicSubnet01Id
      - Ref: PublicSubnet02Id
